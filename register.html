<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activate TEDx Poster QR Code</title>
    <style>
        * {
            color-scheme: dark;
            font-family: 'Inter', sans-serif;
        }
        .tedx-button{ text-decoration: none; color: white; justify-content: center; align-items: center; gap: 10px; border-radius: 0.8rem; border: 2px solid rgba(97, 97, 97, 0.5); background: rgba(74, 74, 74, 0.5); width: max-content; height: max-content; padding: 10px 15px; &.more-padding{ width: 180px; height: 130px; @media screen and (max-width: 750px){ width: 200px!important; height: 60px!important; padding: 10px 5px!important;}} &.medium-padding{ width: 150px; height: 100px;}  &::after{ display: inline-flex; position: relative; color: white; font-weight: 700; height: 100%; content: " \2192" / " "; padding: 0px 2.5px; align-items: center;} &.arrow-up{ .button__label{ &::after{ margin-left: 5px; content: "\2191" / " ";}}} &.no-arrow{ &::after{ display: none; margin: 0; padding: 0; content: "";}} &.red{ background: rgba(178, 57, 57, 0.75); border: 2px solid rgba(77, 24, 24, 0.5); &:hover{ background: rgba(178, 57, 57, 0.85);} &:active{ background: rgba(178, 57, 57, 1);}} &.white{ background: rgba(255, 255, 255, 1); border: 2px solid rgba(77, 24, 24, 0.5);}}
        video {
            width: 100%;
            max-width: 100%;
            height: 100%;
            max-height: 70vh;
        }
        .message-box {
            width: calc(100% - 30px);
            max-width: 500px;
            display: none;
        }

        .success {
            border: 2px solid rgba(43, 80, 44, 0.5); 
            background: rgba(86, 150, 88, 0.5);
            &::before {
                content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' fill='white' height='24' viewBox='0 0 24 24'%3E%3Cpath d='m9.55 18l-5.7-5.7l1.425-1.425L9.55 15.15l9.175-9.175L20.15 7.4z'/%3E%3C/svg%3E");
                fill: white;
            }
        }

        .tedx-logo {
            margin-top: 25px;
            width: 40%;
            max-width: 250px;
        }
        #scan-another {
            display: none;
        }
        h1 {
            margin-top: 0px;
        }
        textarea {
            width: calc(100% - 10px);
            height: 200px;
            font-size: 1.1em;
            display: none;
        }
    </style>
</head>

<body>
    <svg class="tedx-logo" preserveAspectRatio="xMidYMid meet" data-bbox="0 -0.01 2009.41 187.8" viewBox="0 -0.01 2009.41 187.8" xmlns="http://www.w3.org/2000/svg" data-type="color" role="presentation" aria-hidden="true" aria-label="">
        <g>
            <path d="M551.24.57v146.12h-13.32V.57z" fill="#ffffff" data-color="1"></path>
            <path d="M593.43 78.2v68.5h-12.68V37.1h12.33v17.19h1.14c2.57-5.61 6.57-10.12 12.01-13.52s12.17-5.1 20.2-5.1c7.36 0 13.83 1.53 19.42 4.6 5.58 3.07 9.93 7.58 13.04 13.52 3.11 5.95 4.67 13.25 4.67 21.9v70.99h-12.68V76.47c0-8.99-2.51-16.1-7.52-21.33s-11.72-7.85-20.13-7.85c-5.75 0-10.85 1.24-15.32 3.71s-7.99 6.03-10.58 10.67-3.88 10.14-3.88 16.52Z" fill="#ffffff" data-color="1"></path>
            <path d="M729.75 148.98c-8.98 0-16.84-2.38-23.58-7.13-6.75-4.76-12.01-11.39-15.78-19.91-3.78-8.52-5.67-18.43-5.67-29.75s1.89-21.15 5.67-29.64 9.06-15.1 15.85-19.84c6.79-4.73 14.7-7.1 23.73-7.1 6.65 0 12.18 1.18 16.6 3.53s7.96 5.27 10.62 8.74 4.73 6.85 6.2 10.13h1.14V.57h12.75v146.12h-12.4v-20.33h-1.5c-1.47 3.33-3.56 6.74-6.27 10.24s-6.28 6.43-10.72 8.81-9.99 3.57-16.64 3.57m1.5-11.63c7.08 0 13.11-1.94 18.1-5.81 4.99-3.88 8.8-9.23 11.44-16.05s3.95-14.66 3.95-23.51-1.31-16.49-3.92-23.22-6.41-12.01-11.4-15.84-11.04-5.74-18.17-5.74-13.48 1.99-18.49 5.96-8.81 9.34-11.4 16.09c-2.59 6.76-3.88 14.34-3.88 22.76s1.31 16.2 3.92 23.04 6.42 12.29 11.44 16.3q7.515 6.03 18.42 6.03Z" fill="#ffffff" data-color="1"></path>
            <path d="M811.9 18.26c-2.61 0-4.85-.89-6.7-2.67-1.85-1.79-2.78-3.94-2.78-6.46s.93-4.67 2.78-6.46 4.08-2.68 6.7-2.68 4.84.89 6.7 2.68c1.85 1.78 2.78 3.94 2.78 6.46s-.93 4.67-2.78 6.46c-1.85 1.78-4.09 2.67-6.7 2.67m-6.48 128.43V37.1h12.75v109.59z" fill="#ffffff" data-color="1"></path>
            <path d="M875.07 149.19c-6.6 0-12.64-1.3-18.1-3.89s-9.81-6.35-13.04-11.27-4.85-10.9-4.85-17.95c0-5.42 1.02-9.99 3.06-13.7s4.94-6.75 8.69-9.13q5.625-3.57 13.32-5.64c5.13-1.38 10.78-2.45 16.96-3.21 6.13-.76 11.32-1.43 15.57-2s7.49-1.47 9.73-2.71c2.23-1.24 3.35-3.23 3.35-5.99v-2.57c0-7.47-2.22-13.35-6.66-17.66-4.44-4.3-10.82-6.46-19.13-6.46s-14.31 1.74-19.27 5.21q-7.44 5.205-10.44 12.27l-12.04-4.35c2.47-5.99 5.89-10.79 10.26-14.38s9.26-6.18 14.68-7.78c5.42-1.59 10.9-2.39 16.46-2.39 4.18 0 8.54.55 13.07 1.64s8.75 2.98 12.65 5.67c3.89 2.69 7.05 6.42 9.48 11.2 2.42 4.78 3.63 10.83 3.63 18.16v74.42h-12.68v-17.34h-.78c-1.52 3.23-3.78 6.38-6.77 9.42s-6.75 5.54-11.26 7.49-9.81 2.92-15.89 2.92Zm1.71-11.63c6.75 0 12.59-1.5 17.53-4.5s8.75-6.98 11.44-11.95c2.68-4.97 4.03-10.45 4.03-16.45V88.82q-1.425 1.35-4.74 2.43c-2.21.71-4.75 1.35-7.62 1.89-2.87.55-5.74 1.01-8.59 1.39s-5.42.71-7.7 1c-6.18.76-11.45 1.95-15.82 3.57s-7.72 3.84-10.05 6.67-3.49 6.46-3.49 10.88c0 6.66 2.38 11.81 7.13 15.45q7.125 5.46 17.88 5.46" fill="#ffffff" data-color="1"></path>
            <path d="M961.87 78.2v68.5h-12.68V37.1h12.33v17.19h1.14c2.57-5.61 6.57-10.12 12.01-13.52s12.17-5.1 20.2-5.1c7.36 0 13.83 1.53 19.42 4.6 5.58 3.07 9.93 7.58 13.04 13.52 3.11 5.95 4.67 13.25 4.67 21.9v70.99h-12.68V76.47c0-8.99-2.51-16.1-7.52-21.33s-11.72-7.85-20.13-7.85c-5.75 0-10.85 1.24-15.32 3.71s-7.99 6.03-10.58 10.67-3.88 10.14-3.88 16.52Z" fill="#ffffff" data-color="1"></path>
            <path d="M1088.46 149.19c-6.6 0-12.64-1.3-18.1-3.89s-9.81-6.35-13.04-11.27-4.85-10.9-4.85-17.95c0-5.42 1.02-9.99 3.06-13.7s4.94-6.75 8.69-9.13q5.625-3.57 13.32-5.64c5.13-1.38 10.78-2.45 16.96-3.21 6.13-.76 11.32-1.43 15.57-2s7.49-1.47 9.73-2.71c2.23-1.24 3.35-3.23 3.35-5.99v-2.57c0-7.47-2.22-13.35-6.66-17.66-4.44-4.3-10.82-6.46-19.13-6.46s-14.31 1.74-19.27 5.21q-7.44 5.205-10.44 12.27l-12.04-4.35c2.47-5.99 5.89-10.79 10.26-14.38s9.26-6.18 14.68-7.78c5.42-1.59 10.9-2.39 16.46-2.39 4.18 0 8.54.55 13.07 1.64s8.75 2.98 12.65 5.67c3.89 2.69 7.05 6.42 9.48 11.2 2.42 4.78 3.63 10.83 3.63 18.16v74.42h-12.68v-17.34h-.78c-1.52 3.23-3.78 6.38-6.77 9.42s-6.75 5.54-11.26 7.49-9.81 2.92-15.89 2.92Zm1.71-11.63c6.75 0 12.59-1.5 17.53-4.5s8.75-6.98 11.44-11.95c2.68-4.97 4.03-10.45 4.03-16.45V88.82q-1.425 1.35-4.74 2.43c-2.21.71-4.75 1.35-7.62 1.89-2.87.55-5.74 1.01-8.59 1.39s-5.42.71-7.7 1c-6.18.76-11.45 1.95-15.82 3.57s-7.72 3.84-10.05 6.67-3.49 6.46-3.49 10.88c0 6.66 2.38 11.81 7.13 15.45q7.125 5.46 17.88 5.46" fill="#ffffff" data-color="1"></path>
            <path d="M1261.19.57h13.32v96.75c0 9.94-2.33 18.82-6.98 26.65-4.66 7.82-11.13 13.98-19.42 18.48s-17.92 6.74-28.89 6.74-20.54-2.26-28.86-6.78c-8.31-4.52-14.8-10.68-19.45-18.48-4.66-7.8-6.98-16.67-6.98-26.61V.57h13.32v95.82c0 7.75 1.73 14.66 5.2 20.73 3.47 6.06 8.35 10.83 14.64 14.3s13.67 5.21 22.12 5.21 15.84-1.74 22.16-5.21 11.2-8.24 14.64-14.3 5.17-12.97 5.17-20.73V.57Z" fill="#ffffff" data-color="1"></path>
            <path d="M1316.24 78.2v68.5h-12.68V37.1h12.33v17.19h1.14c2.57-5.61 6.57-10.12 12.01-13.52s12.17-5.1 20.2-5.1c7.36 0 13.83 1.53 19.42 4.6 5.58 3.07 9.93 7.58 13.04 13.52 3.11 5.95 4.67 13.25 4.67 21.9v70.99h-12.68V76.47c0-8.99-2.51-16.1-7.52-21.33s-11.72-7.85-20.13-7.85c-5.75 0-10.85 1.24-15.32 3.71s-7.99 6.03-10.58 10.67-3.88 10.14-3.88 16.52Z" fill="#ffffff" data-color="1"></path>
            <path d="M1419.27 18.26c-2.61 0-4.85-.89-6.7-2.67-1.85-1.79-2.78-3.94-2.78-6.46s.93-4.67 2.78-6.46 4.08-2.68 6.7-2.68 4.84.89 6.7 2.68c1.85 1.78 2.78 3.94 2.78 6.46s-.93 4.67-2.78 6.46c-1.85 1.78-4.09 2.67-6.7 2.67m-6.48 128.43V37.1h12.75v109.59z" fill="#ffffff" data-color="1"></path>
            <path d="m1536.18 37.1-39.97 109.59h-13.54L1442.7 37.1h13.75l32.49 92.82h1l32.49-92.82z" fill="#ffffff" data-color="1"></path>
            <path d="M1593.07 148.98c-10.21 0-19.05-2.39-26.51-7.17s-13.22-11.42-17.28-19.91-6.09-18.28-6.09-29.36 2.03-20.85 6.09-29.43q6.09-12.885 16.89-20.19c7.2-4.88 15.52-7.31 24.97-7.31 5.94 0 11.66 1.08 17.17 3.25 5.51 2.16 10.46 5.47 14.86 9.92q6.585 6.675 10.44 16.77c2.57 6.73 3.85 14.69 3.85 23.87v6.28h-85.5V84.5h72.54c0-7.04-1.41-13.38-4.24-19.01q-4.245-8.46-11.76-13.38c-5.01-3.28-10.79-4.92-17.35-4.92-6.94 0-13.04 1.86-18.31 5.57q-7.905 5.565-12.36 14.7c-2.97 6.09-4.48 12.75-4.52 19.98v6.71c0 8.7 1.51 16.3 4.52 22.79 3.02 6.49 7.3 11.52 12.86 15.09s12.14 5.35 19.74 5.35c5.18 0 9.73-.81 13.64-2.43 3.92-1.62 7.22-3.79 9.9-6.53s4.71-5.74 6.09-9.03l12.04 3.93c-1.66 4.61-4.38 8.87-8.16 12.77s-8.48 7.03-14.11 9.38c-5.63 2.36-12.1 3.53-19.42 3.53Z" fill="#ffffff" data-color="1"></path>
            <path d="M1658.64 146.69V37.1h12.33v16.84h.93c2.18-5.52 6-9.98 11.44-13.38s11.6-5.1 18.49-5.1c1.04 0 2.21.03 3.49.07s2.35.1 3.21.14v12.91c-.57-.09-1.57-.24-2.99-.43-1.43-.19-2.97-.29-4.63-.29q-8.55 0-15.21 3.6c-4.44 2.4-7.95 5.72-10.51 9.95-2.57 4.23-3.85 9.06-3.85 14.48v70.78h-12.68Z" fill="#ffffff" data-color="1"></path>
            <path d="m1796.7 61.14-11.61 3.28a30.7 30.7 0 0 0-4.85-8.92c-2.09-2.66-4.81-4.78-8.16-6.35s-7.49-2.35-12.43-2.35q-11.115 0-18.24 5.28c-4.75 3.52-7.13 8.06-7.13 13.63 0 4.71 1.63 8.53 4.88 11.45s8.28 5.24 15.07 6.96l16.53 4.07c9.17 2.24 16.04 5.78 20.63 10.63 4.58 4.85 6.88 10.94 6.88 18.27 0 6.18-1.71 11.68-5.13 16.48s-8.18 8.57-14.29 11.31c-6.1 2.73-13.17 4.1-21.2 4.1-10.69 0-19.5-2.41-26.43-7.24q-10.41-7.245-13.32-20.94l12.18-3c1.57 6.52 4.64 11.44 9.23 14.77s10.63 4.99 18.13 4.99c8.41 0 15.13-1.89 20.17-5.67 5.03-3.78 7.55-8.53 7.55-14.23 0-4.42-1.47-8.14-4.42-11.17s-7.41-5.24-13.4-6.67l-17.88-4.28c-9.5-2.28-16.53-5.9-21.09-10.84-4.56-4.95-6.84-11.08-6.84-18.41 0-6.04 1.64-11.36 4.92-15.95s7.79-8.19 13.54-10.81 12.3-3.93 19.67-3.93c10.02 0 18.04 2.27 24.05 6.81s10.34 10.79 13 18.73Z" fill="#ffffff" data-color="1"></path>
            <path d="M1825.38 18.26c-2.61 0-4.85-.89-6.7-2.67-1.85-1.79-2.78-3.94-2.78-6.46s.93-4.67 2.78-6.46 4.08-2.68 6.7-2.68 4.84.89 6.7 2.68c1.85 1.78 2.78 3.94 2.78 6.46s-.93 4.67-2.78 6.46c-1.85 1.78-4.09 2.67-6.7 2.67m-6.48 128.43V37.1h12.75v109.59z" fill="#ffffff" data-color="1"></path>
            <path d="M1900.9 37.1v11.06h-52.23V37.1zm-35.91-26.26h12.75v107.24c0 4.57.78 8.15 2.35 10.74s3.61 4.42 6.13 5.49 5.2 1.61 8.05 1.61c1.66 0 3.09-.11 4.28-.32s2.23-.44 3.13-.68l2.71 11.49q-1.86.705-4.56 1.32c-1.81.4-4.04.61-6.7.61-4.66 0-9.13-1.02-13.43-3.07-4.3-2.04-7.83-5.09-10.58-9.13s-4.13-9.06-4.13-15.05z" fill="#ffffff" data-color="1"></path>
            <path d="M1933.53 187.79c-2.52 0-4.87-.24-7.05-.71-2.19-.48-3.92-1-5.2-1.57l3.42-11.2c4.32 1.33 8.17 1.82 11.54 1.46s6.37-1.88 8.98-4.57 4.94-6.79 6.98-12.31l3.99-11.13-40.26-110.66h13.75l32.49 92.82h1l32.49-92.82h13.75l-46.31 126.93q-2.925 7.92-7.2 13.23t-9.87 7.92c-3.73 1.74-7.9 2.6-12.5 2.6Z" fill="#ffffff" data-color="1"></path>
            <path d="M40.85 38H0V.59h126.57V38H85.73v108.55H40.85z" fill="#ff0024" data-color="2"></path>
            <path d="M133.54.59h122.87V38h-77.96v18.19h77.96v34.76h-77.96v18.19h77.98v37.41H133.54z" fill="#ff0024" data-color="2"></path>
            <path d="M263.97.59h73.7c48.58 0 65.75 35.98 65.75 72.77 0 44.78-23.68 73.2-74.52 73.2h-64.93zm44.91 108.55h17.56c27.98 0 32.07-22.7 32.07-36.41 0-9.18-2.87-34.73-35.34-34.73h-14.29z" fill="#ff0024" data-color="2"></path>
            <path d="m467.95 90.66-13.7-22.75-13.36 22.75h-32.91l31.24-46-30.08-44h32.92l12.19 21.75L466.79.66h32.91l-30.07 44 31.24 46h-32.91Z" fill="#ff0024" data-color="2"></path>
        </g>
    </svg>
    <h1>Activate Poster</h1>
    <p>Scan a TEDx poster to register the QR with <a href="https://www.tedxiu.com/p" target="_blank" rel="noopener">TEDx Analytical Services</a>. Camera & Geolocation permission is required to register a QR.</p>
    <video id="qr-scanner"></video>
    <textarea name="location-description" id="location-description" placeholder="Describe the poster location (e.g. Luddy AI building, floor 2, above water fountain)"></textarea>
    <div class="status">
        <p id="form-next-button" class="message-box tedx-button" onclick="submitTextarea()">Submit</p>
        <p id="status-box" class="message-box tedx-button no-arrow">
            Loading...
        </p>
        <p id="scan-another" class="message-box tedx-button" onclick="location.reload();">Scan Another</p>
    </div>
    

    <script src="./scripts/qr-scanner.umd.min.js"></script>
    <script>
        const videoElem = document.getElementById('qr-scanner');

        const options = {
            enableHighAccuracy: true,
            timeout: Infinity,
            maximumAge: 0,
        };

        let UTM_CONTENT = "";

        function submitTextarea() {
            document.getElementById('location-description').style.display = 'none';
            document.getElementById('form-next-button').style.display = 'none';
            msg.innerText = "Registering..."
            msg.style.display = "flex";
            navigator.geolocation.getCurrentPosition(registerPoster, error, options);
        }

        async function registerPoster(pos) {
            const crd = pos.coords;
            // console.log(`Accuracy: More or less ${crd.accuracy} meters.`);
            // console.log(`Poster id: ${UTM_CONTENT}`);
            const head = new Headers();
            // head.append("Content-Type", "application/json");
            const desc = document.getElementById('location-description').value;
            const response = await fetch(`https://www.tedxiu.com/_functions/registerposter?poster=${UTM_CONTENT}&long=${crd.longitude}&lat=${crd.latitude}&desc=${desc}`, {
                method: "POST",
                headers: head
            }).then((json) => {
                UTM_CONTENT = "";
                msg.innerText = "Registered Successfully :) "
                msg.classList.add('success');
                msg.style.display = "flex";
                document.getElementById('scan-another').style.display = 'flex';
            });
        }

        function error(err) {
            console.warn(`ERROR(${err.code}): ${err.message}`);
            msg.innerText = "Error: Geolocation permission is required to know where a poster is. Please adjust site and/or device settings to allow geolocation access."
            msg.style.display = "flex";
        }
        const msg = document.getElementById('status-box');

        const qrScanner = new QrScanner(
            videoElem, result => {
                qrScanner.stop();
                let params = new URLSearchParams(decodeURI(result['data'].split('?')[1]));
                if (params.has('utm_content')) {
                    UTM_CONTENT = params.get('utm_content');
                    navigator.permissions.query({ name: "geolocation" }).then((result) => {
                        if (result.state === "granted") {
                            document.getElementById('location-description').style.display = 'block';
                            document.getElementById('form-next-button').style.display = 'block';
                        } else if (result.state === "prompt") {
                            document.getElementById('location-description').style.display = 'block';
                            document.getElementById('form-next-button').style.display = 'block';
                        } else {
                            msg.innerText = "Error: Geolocation permission is required to know where a poster is. Please adjust site and/or device settings to allow geolocation access."
                            msg.style.display = "flex";
                        }
                        // Don't do anything if the permission was denied.
                    });
                } else {
                    msg.innerText = "Error: this QR doesn't contain the 'utm_content' parametre, so it can't be registered."
                    msg.style.display = "flex";
                }
            },
            {
                /* your options or returnDetailedScanResult: true if you're not specifying any other options */
            },
        );
        qrScanner.start();
        // qrScanner.scanImage(image)
        // .then(result => console.log(result))
        // .catch(error => console.log(error || 'No QR code found.'));
    </script>
</body>

</html>