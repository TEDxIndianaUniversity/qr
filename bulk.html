<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <title>Bulk QR-Code Generator</title>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <!-- <link href="https://assets.website-files.com/6246ac7990532afc2998139b/css/bulkr.61864f60c.css" rel="stylesheet" type="text/css" /> -->
    <style>
        * {color-scheme: dark; font-family: 'Inter', 'Helvetica',sans-serif;}
        textarea { resize: vertical; }
        iframe {width: 70vw; height: 80vh}
        .text-field-wrapper {margin-bottom: 10px;}
        .tedx-button{ text-decoration: none; color: white; justify-content: center; align-items: center; gap: 10px; border-radius: 0.8rem; border: 2px solid rgba(97, 97, 97, 0.5); background: rgba(74, 74, 74, 0.5); width: max-content; height: max-content; padding: 10px 15px; &.more-padding{ width: 180px; height: 130px; @media screen and (max-width: 750px){ width: 200px!important; height: 60px!important; padding: 10px 5px!important;}} &.medium-padding{ width: 150px; height: 100px;} &:hover{ background: rgba(74, 74, 74, 0.7);} &:active{ background: #4a4a4a;} .button__label{ color: white; font-weight: 700; &::after{ display: inline-flex; position: relative; color: white; font-weight: 700; height: 100%; content: " \2192" / " "; padding: 0px 2.5px; align-items: center;}} &.arrow-up{ .button__label{ &::after{ margin-left: 5px; content: "\2191" / " ";}}} &.no-arrow{ .button__label{ &::after{ display: none; margin: 0; padding: 0; content: "";}}} &.red{ background: rgba(178, 57, 57, 0.75); border: 2px solid rgba(77, 24, 24, 0.5); &:hover{ background: rgba(178, 57, 57, 0.85);} &:active{ background: rgba(178, 57, 57, 1);}} &.white{ background: rgba(255, 255, 255, 1); border: 2px solid rgba(77, 24, 24, 0.5); .button__label{ color: black; &::after{ color: black;}} &:hover{ background: rgba(255, 255, 255, 0.85);} &:active{ background: rgba(255, 255, 255, 0.75);}}}
        .submit-button-wrapper {margin: 25px 0;}
    </style>
</head>

<body>
    <div class="section wf-section">
        <div class="container">
            <h1>Bulk Poster Generator</h1>
            <h2>Generate Unique QR-Codes for Any Poster</h2>
        </div>
    </div>
    <div class="section grow wf-section">
        <div class="container" style="display: flex; flex-direction: row;gap:15px;">
            <div class="form w-form">
                <form id="qr-form">
                    <div class="form-line">
                        <div class="text-field-wrapper">
                            <label for="posterSelect" class="field-label">Poster Design: </label>
                            <select name="posterSelect" id="poster-select">
                                <option value="1">The Critical Moment - Tipping Point</option>
                                <option value="2">Step into a New Era - Tipping Point</option>
                                <option value="3">Tip the Scales - Tipping Point</option>
                              </select>
                        </div>
                        <div class="text-field-wrapper">
                            <label for="prefixTxt" class="field-label">URL to Redirect to: </label>
                            <input type="text" class="text-field w-input" id="prefixTxt" value="https://www.tedxiu.com"/>
                        </div>
                        
                        <div class="text-field-wrapper">
                            <label for="numberOfCodes" class="field-label">Quantity: </label>
                            <input type="number" class="text-field w-input" min="1" value="10" id="numberOfCodes" />
                        </div>
                        <div hidden class="text-field-wrapper">
                            <label for="file">(File Upload Currently Unsupported)</label>
                            <input type="file" id="file" name="file" accept=".svg,.png">
                        </div>
                        <hr>
                        <div class="text-field-wrapper">
                            <label for="codeSize" class="field-label">QR size (px): </label>
                            <input type="number" class="text-field w-input" min="40" id="codeSize" value="43"/>
                        </div>
                        <div class="text-field-wrapper x-qr-field" onchange="generateQRcodes()">
                            <label>X position:</label>
                            <input id="horizontal" type="range" min="0" max="300" name="xQr" value="162">
                        </div>
                
                        <div class="text-field-wrapper y-qr-field" onchange="generateQRcodes()">
                            <label>Y position:</label>
                            <input id="vertical" type="range" min="0" max="300" name="yQr" value="177">
                        </div>

                        <div hidden class="text-field-wrapper">
                            <label for="inTxt" class="field-label">Code values: </label>
                            <textarea id="inTxt" class="text-field area w-input" placeholder="Enter each text on a new line:"></textarea>
                        </div>
                        <hr>
                        <div class="submit-button-wrapper">
                            <a href="#" class="button w-button tedx-button" onclick="generateQRcodes()">Generate QR Codes</a>
                        </div>
                    </div>
                    
                </form>
            </div>
            <iframe class="preview" id="preview" title="Poster Preview" src="" width="40%" height="600px"></iframe>
        </div>
    </div>
    <script src="./scripts/qrcode-svg.js"></script>
    <script src="./scripts/svg2pdf.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- <script src="./scripts/jspdf.js"></script> -->
    <!-- <script src="https://unpkg.com/jspdf@2.5.2/dist/jspdf.umd.min.js"></script> -->
    <!-- <script src="https://unpkg.com/jspdf@2.5.2/dist/jspdf.umd.min.js"></script> -->
    <script>
        const { jsPDF } = window.jspdf;
        window.html2canvas = html2canvas;
        async function svg2png(svg, width = 1000, height = 1000) {
            const img = new Image();
            img.src = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`;

            await new Promise((resolve, reject) => {
                img.onload = resolve;
                img.onerror = reject;
            });

            const canvas = document.createElement("canvas");
            [canvas.width, canvas.height] = [width, height];

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            return canvas.toDataURL("image/png");
        }
        function generateQRcodes() {
            document.getElementById('preview').removeAttribute('src');
            document.getElementById('preview').srcdoc = `<!DOCTYPE html><p>Loading...</p></html>`;
            const prefix = document.getElementById("prefixTxt").value;
            const width = document.getElementById("codeSize").value;
            const height = width;
            const qrXPosition = document.getElementById('horizontal').value;
            const qrYPosition = document.getElementById('vertical').value;
            const numberOfCodes = document.getElementById("numberOfCodes").value;
            const posterSelection = document.getElementById('poster-select').value;
            let poster = document.getElementById("file").files[0];
            // const allText = document.getElementById("inTxt").value;
            // const codes = allText.match(/[^\n\r]+/g);
            let codes = [];
            for (let index = 0; index < numberOfCodes; index++) {
                codes.push(self.crypto.randomUUID());
            }
            // console.log(codes);

            if (!codes || codes.length === 0) return;


            for (const code of codes) {
                qrcode = new QRCode({
                    content:  `${prefix}?utm_source=poster&utm_content=${code}`,
                    padding: 2,
                    width: width,
                    height: height,
                    color: "black",
                    background: "none",
                    ecl: "L"
                });
                
                const qrElement = document.createElement('image');
                qrElement.src = qrcode.svg();
                const poster = document.createElement('image');
                // poster.src = 'images/3.png';
                var doc = new jsPDF();  
                svg2png(qrcode.svg()).then((img) => {
                    doc.addImage(`images/${posterSelection}.png`, 'PNG', 2, 0, 212, 270);
                    doc.addImage(img, 'JPEG', Number(qrXPosition), Number(qrYPosition), Number(width), Number(width));
                    doc.addPage('letter','p');
                    document.getElementById('preview').removeAttribute('srcdoc');
                    document.getElementById('preview').src = doc.output('bloburi');
                });
            }
            
        }
    </script>
</body>
</html>